import{k as e,z as a,a0 as t,Y as l,u as o,U as s,y as r,m as n,K as u,C as c,a1 as i,a2 as d,a3 as p,a4 as m,o as f,b as g,a as x,w as h,v as _,F as y,c as v,f as b,g as w,d as k,t as C,e as V,a5 as j,p as L,a6 as U,a7 as $,a8 as S,a9 as T,aa as F,ab as G,q as I,s as N,i as O,h as q,V as A,H as D,ac as H}from"./index-53bd83dd.js";import{_ as P}from"./page-meta.4156fa63.js";import{_ as R}from"./u-button.15b0dce0.js";import{_ as W}from"./u-input.75520c73.js";import{_ as z}from"./u-verification-code.452a28bb.js";import{_ as B,a as E}from"./u-modal.3030e885.js";import{u as K}from"./useLockFn.6292a620.js";import{_ as M}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-icon.d48ac815.js";import"./emitter.1571a5d9.js";import"./u-loading.a4f34545.js";import"./u-popup.bbe0211f.js";const Q=M(e({__name:"login",setup(e){const M=a(!0);M.value=t();const Q=j(),Y=L(),J=l(),X=o(),Z=a(!1),ee=s(),ae=a("");a(!1);const te=a(!1),le=r({scene:1,account:"",password:"",code:""}),oe=a(!1),se=a(),re=e=>{ae.value=e};n((()=>X.getWebsiteConfig));const ne=async()=>{var e,a;le.account&&(null==(e=ee.value)?void 0:e.canGetCode)&&(await U({scene:$.LOGIN,mobile:le.account}),uni.$u.toast("发送成功"),null==(a=ee.value)||a.start())},ue=e=>{le.scene=e},ce=e=>{var a;return null==(a=X.getLoginConfig.login_way)?void 0:a.includes(String(e))},ie=n((()=>X.getLoginConfig.wechat_auth)),de=n((()=>1==X.getLoginConfig.login_agreement)),pe=n((()=>1==X.getLoginConfig.third_auth)),me=n((()=>1==X.getLoginConfig.coerce_mobile)),fe=async e=>{const{token:a,mobile:t}=e;if(!t&&me.value)return J.temToken=a,Y.navigateTo("/pages/bind_mobile/bind_mobile"),void m();J.login(e.token),await J.getUser(),uni.$u.toast("登录成功"),m();const l=S();if(l.length>1){const e=l[l.length-2];await Y.navigateBack();const{onLoad:a,options:t}=e;a&&a(t)}else if(T.get(F))try{Y.redirectTo(T.get(F))}catch(o){Y.switchTab(T.get(F))}else Y.reLaunch("/pages/index/index");T.remove(F)},{lockFn:ge}=K((async()=>{if(!te.value&&de.value)return Z.value=!0;if(1==le.scene){if(!le.account)return uni.$u.toast("请输入账号/手机号码");if(!le.password)return uni.$u.toast("请输入密码")}if(2==le.scene){if(!le.account)return uni.$u.toast("请输入手机号码");if(!le.code)return uni.$u.toast("请输入验证码")}p({title:"请稍后..."});try{const e=await H(le);fe(e)}catch(e){m(),uni.$u.toast(e)}})),xe=async(e={getUrl:!0})=>{const{code:a,getUrl:t}=e;if(!t){return await G({code:a})}return await i.getUrl(d.LOGIN),Promise.reject()},he=async()=>{if(!te.value&&de.value)return Z.value=!0,void console.log(Z.value);M.value&&xe()};u((()=>X.getLoginConfig),(e=>{e.login_way&&(le.scene=e.login_way[0])}),{immediate:!0});const _e=n((()=>!(1!=le.scene||!le.account||!le.password)||!(2!=le.scene||!le.account||!le.code)));return c((async()=>{const e=i.getAuthData();try{if(e.code&&e.scene===d.LOGIN){p({title:"请稍后..."});const a=await xe(e);a&&(se.value=a,fe(se.value))}}catch(a){(()=>{const e=Q.query;e.code&&e.state&&(delete e.code,delete e.state,Y.redirectTo({path:Q.path,query:e}))})()}finally{m(),i.setAuthData()}})),(e,a)=>{const t=I(N("page-meta"),P),l=O,o=q,s=I(N("u-button"),R),r=I(N("u-input"),W),n=A,u=I(N("u-verification-code"),z),c=D,i=I(N("u-checkbox"),B),d=I(N("u-modal"),E);return f(),g(y,null,[x(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),x(o,{class:"bg-white login min-h-full flex flex-col items-center px-[40rpx] pt-[120rpx] box-border"},{default:h((()=>[x(o,null,{default:h((()=>[x(l,{src:_(X).getWebsiteConfig.shop_logo,mode:"widthFix",class:"w-[160rpx] h-[160rpx] rounded-full"},null,8,["src"])])),_:1}),x(o,{class:"w-full mt-[140rpx] pb-[60rpx]"},{default:h((()=>[oe.value?w("",!0):(f(),g(y,{key:0},[_(pe)&&M.value&&_(ie)?(f(),v(o,{key:0},{default:h((()=>[x(s,{type:"primary",onClick:he,customStyle:{height:"100rpx"},"hover-class":"none"},{default:h((()=>[b(" 用户一键登录 ")])),_:1})])),_:1})):w("",!0),x(o,{class:"mt-[40rpx]"},{default:h((()=>[x(s,{onClick:a[0]||(a[0]=e=>oe.value=!oe.value),customStyle:{height:"100rpx"},"hover-class":"none"},{default:h((()=>[b(" 手机号登录 ")])),_:1})])),_:1})],64)),oe.value?(f(),g(y,{key:1},[1==le.scene&&ce(1)?(f(),g(y,{key:0},[x(o,{class:"px-[18rpx] border border-solid border-lightc border-light rounded-[10rpx] h-[100rpx] items-center flex"},{default:h((()=>[x(r,{class:"flex-1",modelValue:le.account,"onUpdate:modelValue":a[1]||(a[1]=e=>le.account=e),border:!1,placeholder:"输入账号"},null,8,["modelValue"])])),_:1}),x(o,{class:"px-[18rpx] py-[10rpx] border border-solid border-light rounded-[10rpx] flex h-[100rpx] items-center mt-[40rpx]"},{default:h((()=>[x(r,{class:"flex-1",modelValue:le.password,"onUpdate:modelValue":a[2]||(a[2]=e=>le.password=e),type:"password",placeholder:"输入密码",border:!1},null,8,["modelValue"]),x(n,{url:"/pages/forget_pwd/forget_pwd","hover-class":"none"},{default:h((()=>[x(o,{class:"border-l border-solid border-0 border-light pl-3 text-muted leading-4 ml-3"},{default:h((()=>[b(" 忘记密码？ ")])),_:1})])),_:1})])),_:1})],64)):w("",!0),2==le.scene&&ce(2)?(f(),g(y,{key:1},[x(o,{class:"px-[18rpx] border border-solid border-lightc border-light rounded-[10rpx] h-[100rpx] items-center flex"},{default:h((()=>[x(r,{class:"flex-1",modelValue:le.account,"onUpdate:modelValue":a[3]||(a[3]=e=>le.account=e),border:!1,placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),x(o,{class:"px-[18rpx] border border-solid border-lightc border-light rounded-[10rpx] h-[100rpx] items-center flex mt-[40rpx]"},{default:h((()=>[x(r,{class:"flex-1",modelValue:le.code,"onUpdate:modelValue":a[4]||(a[4]=e=>le.code=e),placeholder:"请输入验证码",border:!1},null,8,["modelValue"]),x(o,{class:"border-l border-solid border-0 border-light pl-3 leading-4 ml-3 w-[180rpx]",onClick:ne},{default:h((()=>[x(u,{ref_key:"uCodeRef",ref:ee,seconds:60,onChange:re,"change-text":"x秒"},null,512),x(c,{class:k(le.account?"text-primary":"text-muted")},{default:h((()=>[b(C(ae.value),1)])),_:1},8,["class"])])),_:1})])),_:1})],64)):w("",!0)],64)):w("",!0),_(de)?(f(),v(o,{key:2,class:"mt-[40rpx]"},{default:h((()=>[x(i,{modelValue:te.value,"onUpdate:modelValue":a[7]||(a[7]=e=>te.value=e),shape:"circle"},{default:h((()=>[x(o,{class:"text-xs flex"},{default:h((()=>[b(" 已阅读并同意 "),x(o,{onClick:a[5]||(a[5]=V((()=>{}),["stop"]))},{default:h((()=>[x(n,{class:"text-primary","hover-class":"none",url:"/pages/agreement/agreement?type=service"},{default:h((()=>[b(" 《服务协议》 ")])),_:1})])),_:1}),b(" 和 "),x(o,{onClick:a[6]||(a[6]=V((()=>{}),["stop"]))},{default:h((()=>[x(n,{class:"text-primary","hover-class":"none",url:"/pages/agreement/agreement?type=privacy"},{default:h((()=>[b(" 《隐私协议》 ")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})):w("",!0),oe.value?(f(),g(y,{key:3},[x(o,{class:"mt-[60rpx]"},{default:h((()=>[x(s,{type:"primary",onClick:a[8]||(a[8]=e=>_(ge)(le.scene)),customStyle:{height:"100rpx",opacity:_(_e)?"1":"0.5"},"hover-class":"none"},{default:h((()=>[b(" 登录 ")])),_:1},8,["customStyle"])])),_:1}),x(o,{class:"flex justify-between mt-[40rpx]"},{default:h((()=>[x(o,null,{default:h((()=>[b("已有账号，使用 "),2==le.scene&&ce(1)?(f(),g("span",{key:0,class:"text-primary",onClick:a[9]||(a[9]=e=>ue(1))},"密码登录")):w("",!0),1==le.scene&&ce(2)?(f(),g("span",{key:1,class:"text-primary",onClick:a[10]||(a[10]=e=>ue(2))},"验证码登录")):w("",!0)])),_:1}),x(n,{url:"/pages/register/register","hover-class":"none"},{default:h((()=>[b("注册账号")])),_:1})])),_:1})],64)):w("",!0)])),_:1}),x(d,{modelValue:Z.value,"onUpdate:modelValue":a[11]||(a[11]=e=>Z.value=e),"show-cancel-button":"","show-title":!1,"confirm-color":"var(--color-primary)",onConfirm:a[12]||(a[12]=e=>{te.value=!0,Z.value=!1}),onCancel:a[13]||(a[13]=e=>Z.value=!1)},{default:h((()=>[x(o,{class:"text-center px-[70rpx] py-[60rpx]"},{default:h((()=>[x(o,null,{default:h((()=>[b(" 请先阅读并同意 ")])),_:1}),x(o,{class:"flex justify-center"},{default:h((()=>[x(n,{"data-theme":"",url:"/pages/agreement/agreement?type=service"},{default:h((()=>[x(o,{class:"text-primary"},{default:h((()=>[b("《服务协议》")])),_:1})])),_:1}),b(" 和 "),x(n,{url:"/pages/agreement/agreement?type=privacy"},{default:h((()=>[x(o,{class:"text-primary"},{default:h((()=>[b("《隐私协议》")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})],64)}}}),[["__scopeId","data-v-80569b4a"]]);export{Q as default};
